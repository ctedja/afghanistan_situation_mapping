---
title: "&nbsp;"
output: 
  flexdashboard::flex_dashboard:
    orientation: row
    vertical_layout: scroll
    theme:
      bg: "#000000"
      fg: "#FFFFFF" 
      primary: "#0074AC"
      secondary: "#0074AC"
      heading_font: "#0074AC"
      navbar-bg: "#000000"
    logo: wfp_white_logo.png
    css: "styles.css"
    navbar:
      - {icon: "ion-ios-keypad-outline", href: "https://analytics.wfp.org/views/Home_Directory/Home?:showAppBanner=false&:embed=true&:display_count=n&:showVizHome=n&:origin=viz_share_link#", target="_blank", align: right}
    
---

```{r setup, include=FALSE}
# A note on resources:
# Weekly
# 1. 'C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Afghanistan_Situation\\1_afg_covid_data.csv'
# 2. 'C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Afghanistan_Situation\\2_afg_displacement_data.csv'
# 3. "C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\3_sc_contour-export-New-Global-Inventory-Overview-Consolidation-CO.xlsx"
# 4. "C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\4_sc_comet_actual_commodities.xlsx"
# 5. "C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\5_sc_food_reconciliation.xlsx"

# Monthly
# 6. 'C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\6_sc_contour-export-AFG_Dispatch2-Copy-of-LTI_Details_Report_Dataset.csv'
# 7. 'C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\7_sc_contour-export-AFG_Subreg_Pipeline-pipeline.csv'
# 8. 'C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\8_resourcing_confirmed_contributions.csv'
# 9. "C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\beneficiary_resourcing_extract_new.xlsx"


library(flexdashboard)
library(bslib)

# The usual suspects
library(readxl)
library(knitr)
library(tidyverse)
library(lubridate)
library(httr)
library(sf)
library(sp)
library(shiny)
library(plotly)
library(htmltools)
# Leaflet for most of our mapping 
library(leaflet)
# For nice tables
library(DT)
# Conflict data API
library(acled.api)
# For matching inconsistent administrative level names
library(stringdist)
# For redistributing our numeric values into new ranges
library(scales)
# To create curved lines for displacement mapping
library(geosphere)
# To ease with rolling averages
library(zoo)
library(htmlwidgets)

# Remove scientific notation
options(scipen=999)

# Create a custom number format to present more legible figures
custom_number_format <- function(x){ifelse(x > 999999, paste(format(round((x/1000000), 1), nsmall=1, big.mark=","),"M"), format(round(x), nsmall=0, big.mark=","))}

# Prepare label fonts
label_font <- list(
  family = "Open Sans, sans-serif",
  size = 11,
  color = "black")

label_format <- list(
  bgcolor = "#F4F4F4",
  bordercolor = "transparent",
  font = label_font,
  align = "right")

# Prepare minimalist axis labels
axis_blank <- list(
  title = "",
  zeroline = FALSE,
  showline = FALSE,
  showgrid = FALSE,
  showticklabels = FALSE)

axis_white_rev <- list(
  title = "",
  zeroline = FALSE,
  showline = FALSE,
  showgrid = FALSE,
  color = "#FFF",
  autorange = "reversed",
  tickfont = list(size= 8,
                  color = "white"))

axis_white <- list(
  title = "",
  zeroline = FALSE,
  showline = FALSE,
  showgrid = FALSE,
  color = "#FFF",
  tickfont = list(size= 10,
                  color = "white"))

axis_white_8pt <- list(
  title = "",
  zeroline = FALSE,
  showline = FALSE,
  showgrid = FALSE,
  color = "#FFF",
  axisangle = 90,
  tickfont = list(size= 8,
                  color = "white"))

axis_time_selector <- list(
      title = "",
      zeroline = FALSE,
      showline = FALSE,
      showgrid = FALSE,
      showticklabels = FALSE,
      rangeselector = list(
        buttons = list(
          list(label = "All",
               step = "all"),
          list(
            count = 3,
            label = "3-months",
            step = "month",
            stepmode = "backward"),
          list(
            count = 1,
            label = "1-month",
            step = "month",
            stepmode = "backward")),
        activecolor = "#2F2F2F",
        bgcolor = "#1F1F1F",
        font = list(color = "#FFFFFF",
                    size = 8),
        yanchor = "top",
        y = 0.95))

```


SAMPLE
=====================================

## Row Title {data-height=60}
<br/>
<span style="color:#FFFFFF;font-size:18px;letter-spacing:4px">&ensp;&ensp;AFGHANISTAN SITUATION (SAMPLE EXCERPT ONLY) </span> <span style="color:#FFFFFF;font-size:12px;letter-spacing:4px"> (`r format(Sys.Date(), "%d %b %Y")`) </span>
<br/> 

``` {r tidy, include = FALSE}
# Load integrated phase classification (IPC) data for latest estimates of food insecurity, disaggregated at provincial levels and publicly available. http://www.ipcinfo.org/ipc-country-analysis/details-map/en/c/1154300/?iso3=AFG
ipc <- read_excel("C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Afghanistan_Situation\\ipc_2021_march.xlsx", skip = 12) %>%
  select(3, 24, 26) %>%
  `colnames<-`(c("adm1_name", "population", "ipc_status")) %>%
  mutate(adm1_name = case_when(adm1_name == "Sari pul" ~ "Sar-e-pul",
                               TRUE ~ adm1_name))

# Load a corporate shapefile with set admin boundaries
geography_adm2 <- read_sf("C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\rbb_adm2_may_2021\\adm2.shp") %>%
  filter(adm0_name == "Afghanistan")


geography_adm1 <- read_sf("C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\rbb_adm1_jul_2021\\adm1.shp") %>%
  filter(adm0_name == "Afghanistan")




# Manual load in of office locations (also publicly available)
offices <- data.frame(adm2_name = c("Hirat", "Kandahar", "Jalalabad", "Mazar-e-Sharif", "Fayz Abad", "Kabul"),
                      office = c("Herat Sub Office", "Kandahar Area Office", "Jalalabad Sub Office", "Mazar Area Office", "Faizabad Sub Office", "Kabul CO and Area Office"))

# There is a way to automate the pull of the data from HDX. But in the meantime, manually download the file. https://gitlab.com/dickoa/rhdx
covid <- read.csv('C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Afghanistan_Situation\\1_afg_covid_data.csv') %>%
  filter(Date != "#date") %>%
  mutate(Cases = as.numeric(gsub(",", "", Cases)),
         Deaths = as.numeric(gsub(",", "", Deaths)),
         Recoveries = as.numeric(gsub(",", "", Recoveries)),
         Date = as.Date(Date),
         Province = gsub("Ã‚", "", Province)) %>%
  mutate(Province = gsub("Province", "", Province)) %>%
  mutate(Province = str_trim(Province)) %>%
  mutate(Province = case_when(Province == "Dykundi" ~ "Daykundi",
                              Province == "Helmand" ~ "Hilmand",
                              Province == "Nooristan" ~ "Nuristan",
                              Province == "Sar-e-Pul" ~ "Sar-e-pul",
                              Province == "Urozgan" ~ "Uruzgan",
                              Province == "Herat" ~ "Hirat",
                              Province == "Paktia" ~ "Paktya",
                              Province == "Panjshir" ~ "Panjsher",
                              Province == "Nimruz" ~ "Nimroz",
                              Province == "Jowzjan" ~ "Jawzjan",
                              Province == "Sar-e Pol" ~ "Sar-e-pul",
                              TRUE ~ Province))


covid_latest <- covid %>%
  filter(Date == max(Date)) %>%
  mutate(scaled_cases = rescale(Cases, to = c(5000, 40000))) %>%
  select(c(Province, Cases, scaled_cases))


# Add conflict data, tidy and ensure clean and matching adm2 level names using amatch.
conflict <- acled.api(email.address = "clinton.tedja@wfp.org",
                      access.key = "nrSMy2xwZwCbaaMfXW2W",
                      country = "Myanmar", 
                      start.date = "2021-01-01", 
                      end.date = Sys.Date())


conflict_agg <- conflict %>%
  mutate(event_date = as.Date(event_date)) %>%
  mutate(fatalities_14 = case_when(event_date >= (as.Date((max(conflict$event_date))) - 14) ~ fatalities,
                                   TRUE ~ 0)) %>%
  group_by(admin2) %>%
  summarise(fatalities = sum(fatalities),
            fatalities_14 = sum(fatalities_14)) %>%
  as_tibble() %>%
  mutate(temp = amatch(admin2, geography_adm2$adm2_name, maxDist = 10)) %>%
  mutate(admin2 = (geography_adm2[.$temp,])$adm2_name) %>%
  select(-c(temp)) %>%
  mutate(scaled_fatalities = rescale(fatalities, to = c(8000,50000)),
         scaled_fatalities_14 = rescale(fatalities_14, to = c(8000,50000)))


# Merge into two databases for adm1 and adm2 level 
map_data_adm1 <- left_join(geography_adm1, ipc, by = "adm1_name") %>%
  left_join(covid_latest, by = c("adm1_name" = "Province")) %>%
  mutate(as.vector(as.data.frame(st_coordinates(st_centroid(geometry)))["X"]),
         as.vector(as.data.frame(st_coordinates(st_centroid(geometry)))["Y"])) %>%
  mutate(adm1_zone = case_when(adm1_name == "Badakhshan" ~ "1",
                                                  adm1_name == "Takhar" ~ "1",
                                                  adm1_name == "Kunduz" ~ "1",
                                                  adm1_name == "Baghlan" ~ "1",
                                                  adm1_name == "Samangan" ~ "1",
                                                  adm1_name == "Balkh" ~ "1",
                                                  adm1_name == "Jawzjan" ~ "1",
                                                  adm1_name == "Faryab" ~ "1",
                                                  adm1_name == "Badghis" ~ "2",
                                                  adm1_name == "Ghor" ~ "2",
                                                  adm1_name == "Hirat" ~ "2",
                                                  adm1_name == "Farah" ~ "2",
                                                  TRUE ~ "3")) %>%
  mutate(adm1_zone = as.double(adm1_zone))

map_data_adm2 <- left_join(geography_adm2, offices, by = "adm2_name") %>%
  left_join(conflict_agg, by = c("adm2_name" = "admin2")) %>%
    mutate(as.vector(as.data.frame(st_coordinates(st_centroid(geometry)))["X"]),
           as.vector(as.data.frame(st_coordinates(st_centroid(geometry)))["Y"]))


# COVID-19 Graph, taken from the JHU time series simply because the location-disaggregated data has some inconsistencies
covid_timeseries <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv") %>%
   pivot_longer(names_to = "date", 
               values_to = "cases", 
               cols = -c(Province.State, Country.Region, Lat, Long)) %>%
  mutate(date = as.Date(str_remove(date, "X"), 
                        format = "%m.%d.%y"),
         cases = as.double(cases)) %>%
  rename(country = Country.Region) %>%
  filter(country == "Afghanistan") %>%
  select(c(country, date, cases)) %>%
  group_by(country) %>% 
  mutate(new_cases = c(cases[1],diff(cases))) %>%
  mutate(roll_cases = round(rollmean(new_cases, 7,
                                          align="center",
                                          fill=0), 
                                 digits = 2)) %>%
  mutate(roll_cases = case_when(date < min(date)+7 ~ 
                                       round(rollmean(new_cases, 7,
                                                      align="left",
                                                      fill=0),
                                             digits = 2),
                                     date > max(date)-7 ~ 
                                       round(rollmean(new_cases, 7,
                                                      align="right",
                                                      fill=0),
                                             digits = 2),
                                             TRUE ~ roll_cases))


# Moving onto displacement data:
# Extract coordinates only
adm2_coord <- geography_adm2 %>%
  mutate(as.vector(as.data.frame(st_coordinates(st_centroid(geometry)))["X"]),
         as.vector(as.data.frame(st_coordinates(st_centroid(geometry)))["Y"])) %>%
  as.data.frame() %>%
  select(c("adm2_name", "X", "Y"))


# Load displacement data https://data.humdata.org/dataset/afghanistan-conflict-induced-displacements-in-2021
displacements <- read.csv('C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Afghanistan_Situation\\2_afg_displacement_data.csv') %>%
  filter(DISP_IND != "#affected+displaced") %>%
  select(c("DISP_DATE", "ORIG_DIST_NAME", "ORIG_PROV_NAME","DISP_DIST_NAME", "DISP_PROV_NAME", "DISP_IND")) %>%
  mutate(DISP_IND = as.integer(DISP_IND)) %>%
  # Aggregate for a cumulative figure. Undo this for time series. 
  group_by(ORIG_PROV_NAME, ORIG_DIST_NAME, DISP_PROV_NAME, DISP_DIST_NAME) %>%
  summarise(DISP_IND = sum(DISP_IND)) %>%
  as_tibble() %>%
  mutate(temp = amatch(ORIG_DIST_NAME, geography_adm2$adm2_name, maxDist = 10)) %>%
  mutate(ORIG_DIST_NAME = (geography_adm2[.$temp,])$adm2_name) %>%
  select(-c(temp)) %>%
  mutate(temp = amatch(DISP_DIST_NAME, geography_adm2$adm2_name, maxDist = 10)) %>%
  mutate(DISP_DIST_NAME = (geography_adm2[.$temp,])$adm2_name,
         # Redistribute data along a new scale to map different line widths
         line_width = rescale(DISP_IND, to = c(1,11)),
         DISP_DIST_NAME = case_when(is.na(DISP_DIST_NAME) ~ ORIG_DIST_NAME,
                                    TRUE ~ DISP_DIST_NAME))

displacements_agg <- custom_number_format(sum(displacements$DISP_IND))

displacements <- displacements %>%
  select(-c(temp)) %>%
  left_join(adm2_coord, by = c("DISP_DIST_NAME" = "adm2_name")) %>%
  rename(DISP_X = X,
         DISP_Y = Y) %>%
  left_join(adm2_coord, by = c("ORIG_DIST_NAME" = "adm2_name")) %>%
  rename(ORIG_X = X,
         ORIG_Y = Y) %>%
  # Removing NAs. Undo this for the aggregate figure though.
  filter(!is.na(DISP_DIST_NAME)) %>%
  filter(!is.na(ORIG_DIST_NAME))


# Build dataframe for destination points
disp_dest <- displacements %>%
  group_by(DISP_PROV_NAME, DISP_DIST_NAME, DISP_X, DISP_Y) %>%
  summarise(DISP_IND = sum(DISP_IND)) %>%
  ungroup() %>%
  mutate(circle = rescale(DISP_IND, to = c(4000,40000), from = range(displacements$DISP_IND)))

# And one for the table at province level
disp_prov <- displacements %>%
  group_by(DISP_PROV_NAME) %>%
  summarise(DISP_IND = sum(DISP_IND)) %>%
  left_join(displacements %>%
              group_by(ORIG_PROV_NAME) %>%
              summarise(DISP_IND = sum(DISP_IND)),
            by = c('DISP_PROV_NAME' = 'ORIG_PROV_NAME')) %>%
  rename(Destination = DISP_IND.x,
         Origin = DISP_IND.y,
         Province = DISP_PROV_NAME)


# Build dataframe for origin points
disp_orig <- displacements %>%
  group_by(ORIG_PROV_NAME, ORIG_DIST_NAME, ORIG_X, ORIG_Y) %>%
  summarise(ORIG_IND = sum(DISP_IND)) %>%
  ungroup() %>%
  mutate(circle = rescale(ORIG_IND, to = c(4000,30000), from = range(displacements$DISP_IND)))


disp_time_series <- read.csv('C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Afghanistan_Situation\\2_afg_displacement_data.csv') %>%
  filter(DISP_IND != "#affected+displaced") %>%
  mutate(DISP_DATE = as.Date(DISP_DATE, format = "%d-%m-%y"),
         DISP_IND = as.integer(DISP_IND)) %>%
  filter(!is.na(DISP_DATE)) %>%
  group_by(DISP_DATE) %>%
  summarise(DISP_IND = sum(DISP_IND)) %>%
  mutate(DISP_IND = as.double(DISP_IND)) %>%
  mutate(roll_disp = round(rollmean(DISP_IND, 7,
                                     align="center",
                                     fill=0),
                            digits = 2)) %>%
  mutate(roll_disp = case_when(roll_disp > 0 ~ roll_disp,
                                     TRUE ~ DISP_IND))


```


## Row Situation Boxes
### Estimated food insecure {.bgblack}
```{r}
# Manual IPC figure
valueBox("14 M", icon = "ion-ionic", color="#111111", href= "http://www.ipcinfo.org/ipc-country-analysis/details-map/en/c/1154300/?iso3=AFG")

```

### Cumulative COVID-19 Cases {.bgblack}
```{r}
# 
valueBox(custom_number_format(max(covid_timeseries$cases)), icon = "ion-ios-pulse", color="#111111", href= "https://analytics.wfp.org/views/COVID-19RBBCases/Cases?iframeSizedToWindow=true&:embed=y&:showAppBanner=false&:render=TRUE&:display_count=no&:showVizHome=no&:origin=viz_share_link")
```

### Conflict-Induced Internal Displacements in 2021 (so far) {.bgblack}
```{r}
valueBox(displacements_agg, icon = "ion-ios-shuffle",color="#111111", href= "https://data.humdata.org/dataset/afghanistan-conflict-induced-displacements-in-2021")
```


## Row Situation {.tabset data-height=580}
### RISK FACTORS {.bgblack}
```  {r risk map}
# Prepare a map with leaflet
ipc_map_label <- paste0(
  "<b>",map_data_adm1$adm1_name, "</b>", 
  "<br/>",
  "IPC level ", map_data_adm1$ipc_status) %>%
  lapply(htmltools::HTML)

covid_map_label <- paste0(
  "<span style=\"color:#BC7557;font-weight:bold\">", map_data_adm1$adm1_name, " Province", "</span>",  
  "<br/>",
  custom_number_format(map_data_adm1$Cases), " cumulative cases") %>%
  lapply(htmltools::HTML)

conflict_map_label <- paste0(
  "<span style=\"color:#923750;font-weight:bold\">", map_data_adm2$adm1_name, ", ", map_data_adm2$adm2_name, ": ", "</span>",  
  "<br/>",
  custom_number_format(map_data_adm2$fatalities), " conflict-related fatalities in 2021") %>%
  lapply(htmltools::HTML)

conflict_map_label_14 <- paste0(
  "<span style=\"color:#923750;font-weight:bold\">", map_data_adm2$adm1_name, ", ", map_data_adm2$adm2_name, ": ", "</span>",  
  "<br/>",
  custom_number_format(map_data_adm2$fatalities_14), " conflict-related fatalities in 14 days prior to ", format(as.Date(max(conflict$event_date)), format = "%d-%b")) %>%
  lapply(htmltools::HTML)


map_colors <- colorFactor(palette = c("#923750", "#EE7449", "#FCC261"), 
                   levels = c(4, 3, 2))


# Build the map
risk_map <- leaflet(map_data_adm1) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.DarkMatter) %>%
  addTiles("https://api.mapbox.com/styles/v1/ctedja/ckt4kzvju15yu17qo3ianralh/tiles/256/{z}/{x}/{y}@2x?access_token=TOKEN") %>%
  addTiles("https://api.mapbox.com/styles/v1/ctedja/ckt4licat16cu17p571olhq35/tiles/256/{z}/{x}/{y}@2x?access_token=TOKEN", group = "Main Roads") %>%
  setView(lat = 34.3, lng = 68, zoom = 5.5) %>%
  # IPC layer
  addPolygons(
    fillColor = ~map_colors(map_data_adm1$ipc_status),
    fillOpacity = 0.8,
    color = "white",
    stroke = TRUE,
    weight = 1,
    label = ipc_map_label,
    group="IPC",
    highlightOptions = highlightOptions(weight = 4, 
                                        color = "white")) %>%
  addLegend("bottomright", 
            colors= c("#923750", "#EE7449", "#FCC261"), 
            labels=c("IPC Level 4", "IPC Level 3", "IPC Level 2"), 
            title="IPC",
            group = "IPC") %>%
  # Office layer
  addCircles(data = filter(map_data_adm2, !is.na(office)), lng = ~X, lat = ~Y,
             label = ~htmlEscape(office),
             color = "#0074AC",
             weight = 0,
             radius = 20000,
             fillOpacity = 0.8,
             highlightOptions = highlightOptions(fillColor = "#FFFFFF"),
             group="Offices") %>%
  # COVID-19 layer
  addCircles(data = filter(map_data_adm1, !is.na(Cases)), lng = ~X, lat = ~Y,
             label = covid_map_label,
             color = "#F6A57F",
             radius = ~scaled_cases,
             fillOpacity = 0.8,
             weight = 0,
             highlightOptions = highlightOptions(fillColor = "#FFFFFF"),
             group="COVID-19") %>%
  # Conflict layer
  addCircles(data = map_data_adm2, lng = ~X, lat = ~Y,
             label = conflict_map_label,
             color = "#B7767E",
             radius = ~scaled_fatalities,
             weight = 0,
             fillOpacity = 0.8,
             highlightOptions = highlightOptions(fillColor = "#FFFFFF"),
             group="Conflict (2021)") %>%
  # Conflict - 14 layer
  addCircles(data = map_data_adm2, lng = ~X, lat = ~Y,
             label = conflict_map_label_14,
             color = "#B7767E",
             radius = ~ scaled_fatalities_14,
             weight = 0,
             fillOpacity = 0.8,
             highlightOptions = highlightOptions(fillColor = "#FFFFFF"),
             group="Conflict (14 days)") %>%
  addLayersControl(baseGroups = c("Conflict (2021)", "Conflict (14 days)", "COVID-19", "IPC"),
                   overlayGroups = c("Main Roads", "Offices"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup(c("Conflict (14 days)", "COVID-19", "IPC", "Offices"))


# Covid graph
covid_graph_label <- paste0(
  format(as.Date(covid_timeseries$date), format = "%d %b %Y"),
  "<br>",  
  "<b>", custom_number_format(covid_timeseries$new_cases),"</b>",  
  " new cases",
  "<br><br>",
  "<span style=\"color:#BC7557\">", "7-day average: ", "<b>","<br>", custom_number_format(covid_timeseries$roll_cases),"</b>", "</span>",
  " new cases",
  "<br>") %>%
  lapply(htmltools::HTML)


covid_graph <- plot_ly(
  data = covid_timeseries,
  x = ~date,
  y = ~roll_cases,
  type = 'scatter',
  mode = 'lines',
  line = list(width = 1.5),
  color = I("#F6A57F"),
  text = covid_graph_label,
  hoverinfo = 'text',
  hoverlabel = label_format) %>%
  add_trace(x = ~date,
            y = ~new_cases,
            color = I("#3F3F3F"),
            type = 'bar') %>%
  layout(
    paper_bgcolor='#111111',
    plot_bgcolor='#111111',
    showlegend = FALSE,
    xaxis = axis_time_selector,
    yaxis = axis_blank,
    margin = list(r = 10, t = 25, b = 0, l = 5),
    title = list(text = "<b>COVID-19</b>", xanchor = "left", x = 0.05, yanchor = "top"),
    titlefont = list(
      color = '#F6A57F',
      size = 10)) %>%
  highlight(on = "plotly_hover") %>% 
  onRender("function(el, x) {Plotly.d3.select('.cursor-crosshair').style('cursor', 'pointer')}") %>%
  config(displayModeBar = F)

# ConflictGraph
conflict_graph <- conflict %>%
  mutate(event_date = as.Date(event_date)) %>%
  select(c(event_date, fatalities)) %>% 
  group_by(event_date) %>%
  summarise(fatalities = sum(fatalities)) %>%
  mutate(roll_fatalities = round(rollmean(fatalities, 7,
                                          align="center",
                                          fill=0),
                                 digits = 2)) %>%
  # Fix dead tails
  mutate(roll_fatalities = case_when(event_date < min(event_date)+7 ~ 
                                       round(rollmean(fatalities, 7,
                                                      align="left",
                                                      fill=0),
                                             digits = 2),
                                     event_date > max(event_date)-7 ~ 
                                       round(rollmean(fatalities, 7,
                                                      align="right",
                                                      fill=0),
                                             digits = 2),
                                             TRUE ~ roll_fatalities))

conflict_graph_label <- paste0(
  format(as.Date(conflict_graph$event_date), format = "%d %b %Y"),
  "<br>",  
  "<b>", conflict_graph$fatalities,"</b>",  
  " conflict-related fatalities",
  "<br><br>",
  "<span style=\"color:#923750\">", "7-day average: ", "<b>", "<br>",
  conflict_graph$roll_fatalities,"</b>", "</span>",
  " conflict-related fatalities",
  "<br>") %>%
  lapply(htmltools::HTML)


conflict_graph <- plot_ly(
  data = conflict_graph,
  x = ~event_date,
  y = ~roll_fatalities,
  type = 'scatter',
  mode = 'lines',
  line = list(width = 1.5),
  color = I("#B7767E"),
  text = ~conflict_graph_label,
  hoverinfo = 'text',
  hoverlabel = label_format) %>%
  add_trace(x = ~event_date,
            y = ~fatalities,
            color = I("#3F3F3F"),
            type = 'bar') %>%
  layout(
    paper_bgcolor='#111111',
    plot_bgcolor='#111111',
    showlegend = FALSE,
    xaxis = axis_time_selector,
    yaxis = axis_blank,
    margin = list(r = 10, t = 25, b = 0, l = 5),
    title = list(text = "<b>Conflict-related fatalities in 2021</b>", xanchor = "left", x = 0.05, yanchor = "top"),
    titlefont = list(
      color = '#CD9B9F',
      size = 10)) %>%
  highlight(on = "plotly_hover") %>% 
  config(displayModeBar = F)


fillCol(flex = c(5, 94.5, 0.5),
        paste0("<span style=\"color:#FFFFFF;font-size:12px;letter-spacing:4px;font-weight:bold\">",
                                 " RISK FACTORS", "</span>", "<br>") %>% lapply(htmltools::HTML),
        fillRow(flex = c(66, 3, 31), 
                risk_map, 
                "",
                fillCol(
                  flex = c(48, 2, 48),
                  conflict_graph, "", covid_graph)),
        paste0("<span style=\"color:#FFF;font-size:9px;font-style:italic\">",
               "&ensp;Conflict data from ACLED. 14 days refers to ", format(as.Date(max(conflict$event_date))-14, format = "%d %B %Y"), " to ", format(as.Date(max(conflict$event_date)), format = "%d %B %Y"), ". Food insecurity data from IPC. COVID-19 data from WHO", "</span>") %>% lapply(htmltools::HTML)
        )
```

### INTERNAL DISPLACEMENTS
```  {r displacement map}
# Build a spatial lines dataframe
listlines <- list()
for (i in 1:nrow(displacements)) {
  connection <- gcIntermediate(c(displacements[i,]$ORIG_X, displacements[i,]$ORIG_Y),
                       c(displacements[i,]$DISP_X, displacements[i,]$DISP_Y),
                       n = 20,
                       addStartEnd = TRUE,
                       sp = TRUE)
  
  listlines[[i]] <- Lines(connection@lines[[1]]@Lines, ID = i)
}

sldf <- SpatialLinesDataFrame(SpatialLines(listlines), data.frame(count = displacements$DISP_IND))


# Create labels
disp_orig_map_label <- paste0("<span style=\"color:#58ADB3\">",
                              "<b>","ORIGIN: ", "</b>", "</span>",
                              "<br/>",
                              custom_number_format(disp_orig$ORIG_IND),
                              " individuals displaced", 
                              "<br/>",
                              " from ",
                              disp_orig$ORIG_DIST_NAME,
                              " (", disp_orig$ORIG_PROV_NAME, ")") %>%
  lapply(htmltools::HTML)


disp_dest_map_label <- paste0("<span style=\"color:#B7767E\">",
                              "<b>","DESTINATION: ", "</b>", "</span>",
                              "<br/>",
                              custom_number_format(disp_dest$DISP_IND),
                              " individuals displaced", 
                              "<br/>",
                              " to ",
                              disp_dest$DISP_DIST_NAME,
                              " (", disp_dest$DISP_PROV_NAME, ")") %>%
  lapply(htmltools::HTML)


displacement_map_label <- (paste0("<b>", custom_number_format(displacements$DISP_IND), "</b>",
                                  " individuals displaced",
                                  "<br/>",
                                  " from ",
                                  displacements$DISP_DIST_NAME,
                                  " (",displacements$DISP_PROV_NAME,")",
                                  "<br/>", " to ",
                                  displacements$ORIG_DIST_NAME,
                                  " (",displacements$ORIG_PROV_NAME,")")) %>%
  lapply(htmltools::HTML)


# Build the map
displacement_map <- leaflet(data = sldf) %>%
  setView(lat = 34.3, lng = 68, zoom = 5.5) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.DarkMatter) %>%
  addTiles("https://api.mapbox.com/styles/v1/ctedja/ckt4kzvju15yu17qo3ianralh/tiles/256/{z}/{x}/{y}@2x?access_token=TOKEN") %>%
  addTiles("https://api.mapbox.com/styles/v1/ctedja/ckt4licat16cu17p571olhq35/tiles/256/{z}/{x}/{y}@2x?access_token=TOKEN", group = "Main Roads") %>%
  # Routes
  addPolylines(data = sldf,
               weight = displacements$line_width,
               color = "#C0DCDC",
               label = displacement_map_label,
               highlightOptions = highlightOptions(color = "white", 
                                                   weight = 6),
               group = "Movements") %>%
  # Destinations
  addCircles(data = disp_dest, lng = ~DISP_X, lat = ~DISP_Y,
             color = "#B7767E",
             radius = ~circle,
             weight = 0,
             fillOpacity = 0.8,
             highlightOptions = highlightOptions(fillColor = '#FFFFFF'),
             label = disp_dest_map_label,
             group="Destinations") %>%
  # Origins
  addCircles(data = disp_orig, lng = ~ORIG_X, lat = ~ORIG_Y,
             color = "#9ECBCC",
             radius = ~circle,
             weight = 0,
             fillOpacity = 0.8,
             label = disp_orig_map_label,
             highlightOptions = highlightOptions(fillColor = '#FFFFFF'),
             group="Origins") %>%
  # Legend
  addLegend("bottomright",
            colors= c("#B7767E"),
            labels=c("Destination"),
            group = "Destinations") %>%
  addLegend("bottomright",
            colors= c("#9ECBCC"),
            labels=c("Origin"),
            group = "Origins") %>%
  # Layer Control
  addLayersControl(overlayGroups = c("Destinations", "Origins", "Movements", "Main Roads"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup(c("Main Roads"))


disp_graph_label <- paste0(
  format(as.Date(disp_time_series$DISP_DATE), format = "%d %b %Y"),
  "<br>",  
  "<b>", disp_time_series$DISP_IND,"</b>",  
  " internal displacements",
  "<br><br>",
  "<span style=\"color:#58ADB3\">", "7-day average: ", "<b>", "<br>",
  disp_time_series$roll_disp,"</b>", "</span>",
  " internal displacements",
  "<br>") %>%
  lapply(htmltools::HTML)


disp_graph <- plot_ly(
  data = disp_time_series,
  x = ~DISP_DATE,
  y = ~roll_disp,
  type = 'scatter',
  mode = 'lines',
  color = I("#9ECBCC"),
  text = disp_graph_label,
  hoverinfo = 'text',
  hoverlabel = label_format) %>%
  add_trace(x = ~DISP_DATE,
            y = ~DISP_IND,
            color = I("#3F3F3F"),
            type = 'bar') %>%
  layout(
    paper_bgcolor='#111111',
    plot_bgcolor='#111111',
    showlegend = FALSE,
    xaxis = axis_time_selector,
    yaxis = axis_blank,
    margin = list(r = 0, t = 25, b = 0, l = 0),
    title = list(text = "<b>Internal Displacements</b>", xanchor = "left", x = 0.05, yanchor = "top"),
    titlefont = list(
      color = '#9ECBCC',
      size = 10))  %>% 
  onRender("function(el, x) {Plotly.d3.select('.cursor-crosshair').style('cursor', 'pointer')}")%>% 
  config(displayModeBar = F)


disp_table <- datatable(arrange(disp_prov, desc(Destination)),
                        class = c("hover"),
                        filter = "none",
                        autoHideNavigation = TRUE,
                        rownames = FALSE,
                        options = list(dom = 't', pageLength = length(unique(disp_prov$Province))),
                        fillContainer = TRUE,
                        colnames = c("Province", "Destination", "Origin")) %>%
  formatStyle(
    'Destination',
    color = "#B7767E",
    background = styleColorBar(disp_prov$Destination, '#111111'),
    backgroundSize = '100% 60%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  ) %>%
  formatStyle(
    'Origin',
    color = "#9ECBCC",
    background = styleColorBar(disp_prov$Origin, '#111111'),
    backgroundSize = '90% 60%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  ) %>%
  formatRound(c(2:3), digits = 0, interval = 3, mark = ",")


fillCol(flex = c(5, 94.5, 0.5),
        paste0("<span style=\"color:#FFFFFF;font-size:12px;letter-spacing:4px;font-weight:bold\">",
                                 " INTERNAL DISPLACEMENTS", "</span>", "<br>") %>% lapply(htmltools::HTML),
        fillRow(flex = c(66, 3, 31), 
                displacement_map, 
                "",
                fillCol(
                  flex = c(44, 2, 4, 2, 44),
                  disp_graph, "", 
                  paste0("<span style=\"color:#9ECBCC;font-size:10px;font-weight:bold\">",
                                         "Internal Displacements (by province)", "</span>") %>% lapply(htmltools::HTML), 
                  "", disp_table)),
        paste0("<span style=\"color:#FFF;font-size:9px;font-style:italic\">",
               "&ensp;OCHA: ", format(file.info("C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Afghanistan_Situation\\2_afg_displacement_data.csv")$mtime, format = "%d %b %Y"), "</span>") %>% lapply(htmltools::HTML)
        )
```

### REPORTS
``` {r evidence}

# Build Iran, but it's different because it falls under a different RB and has different requirements.
api_url_iran <- GET("https://api.reliefweb.int/v1/reports?appname=apidoc&profile=full&limit=1000&filter[operator]=AND&filter[conditions][0][operator]=OR&filter[conditions][0][conditions][0][field]=primary_country&filter[conditions][0][conditions][0][value]=Iran%20(Islamic%20Republic%20of)&filter[conditions][1][field]=date.created&filter[conditions][1][value][from]=2016-01-01T00:00:00%2B00:00&filter[conditions][2][field]=source.shortname&filter[conditions][2][value]=WFP")

reliefweb_iran <- bind_rows(lapply(c(content(api_url_iran)$data),
                                 as.data.frame)) %>%
  select(c(fields.date.created,
           fields.primary_country.name,
           fields.format.name,
           #fields.source.shortname,
           fields.title,
           #fields.origin,
           #fields.file.url,
           #fields.body,
           fields.url_alias#,
           #fields.file.preview.url.thumb
           )) %>%
  mutate(fields.date.created = as.Date(fields.date.created, 
                                          format = "%Y-%m-%d", 
                                          tz = "UTC")) %>%
  rename(Country = fields.primary_country.name,
         Category = fields.format.name,
         Title = fields.title,
         Date = fields.date.created,
         Link = fields.url_alias#,
         #Alt_Link = fields.file.url,
         #Author = fields.source.shortname,
         #Summary = fields.body,
         #Origin_Link = fields.origin,
         #Image = fields.file.preview.url.thumb
         ) %>%
  mutate(Category = case_when(Category == "Map" ~ "Dashboards/Maps/Infographics",
                              Category == "Infographic" ~ "Dashboards/Maps/Infographics",
                              Category == "Evaluation and Lessons Learned" ~ "Evaluations",
                              Category == "Assessment" ~ "Assessments (Food Security and Nutrition)",
                              Category == "Analysis" ~ "Analysis/Research",
                              Category == "News and Press Release" ~ "Stories/Articles",
                              TRUE ~ Category)) %>%
  mutate(Category = case_when(grepl("market", Title, ignore.case = TRUE) ~ "Market/Price Monitoring",
                              grepl("price", Title, ignore.case = TRUE) ~ "Market/Price Monitoring",
                              grepl("country brief", Title, ignore.case = TRUE) ~ "Country Brief",
                              grepl("annual country report", Title, ignore.case = TRUE) ~ "Annual Country Report",
                              TRUE ~ Category)) # %>%
  # filter(!grepl("country brief", Title, ignore.case = TRUE))
rm(api_url_iran)

evidence <- read_excel('C:\\Users\\clinton.tedja\\OneDrive - World Food Programme\\Documents (OneDrive)\\Data\\Evidence_Backend\\Evidence_Mapping.xlsx') %>% 
  select(c(Country, Date, Category, Title, Link))%>%
  bind_rows(reliefweb_iran) %>% 
  filter(Country == "Afghanistan" |
           Country == "Pakistan" |
           Country == "Tajikistan" |
             Country == "Iran (Islamic Republic of)",
         !is.na(Link)) %>%
  mutate(Title = paste0("<a href=\"", Link,"\" target=\"_blank\">", Title,"</a>")) %>%
  select(-c(Link)) %>%
  distinct(Title, .keep_all = TRUE)


# A quick manual input to add additional files
evidence <- bind_rows(data_frame(Country = c("Iran (Islamic Republic of)"), Date = as.Date(c("2021-08-17", "2021-08-09")), Category = "Situation Report", Title = c("Flash Update 2", "Flash Update 1"), Link = c("https://wfp.sharepoint.com/:b:/s/RBB/ESx_RvioxudBg6lprEAglJYB5Rnypor8zQ55op776iFmGw?e=kZV5me", "https://wfp.sharepoint.com/:b:/s/RBB/EekFsQNibF1CpmMxI3jq_20BUHJb__eh2uBFW9NuZ2zYPQ?e=gvfwDO")) %>%
                        mutate(Title = paste0("<a href=\"", Link,"\" target=\"_blank\">", Title,"</a>")) %>%
                        select(-c(Link)),
                  evidence)

evidence <- evidence %>%
  arrange(desc(Date)) %>%
  mutate(Date = format(Date, format = "%d %b %y"))


afg_evidence_table <- datatable(filter(evidence, Country == "Afghanistan"),
                            class = c("hover"),
                            filter = "none",
                            autoHideNavigation = TRUE,
                            rownames = FALSE,
                            options = list(dom = 'ft', 
                                           rowCallback = JS(
                                             "function(row, data) {",
                                             "var full_text = 'This rows values are :' + data[0] + ',' + data[1] + '...'",
                                             "$('td', row).attr('title', full_text);",
                                             "}"),
                                           pageLength = length(unique(evidence$Title))),
                            escape = FALSE,
                            fillContainer = TRUE)


fillCol(flex = c(5, 94.5, 0.5),
        paste0("<span style=\"color:#FFFFFF;font-size:12px;letter-spacing:4px;font-weight:bold\">",
                                 " REPORTS", "</span>", "<br>") %>% lapply(htmltools::HTML),
        fillRow(afg_evidence_table),
        height = "700")


```


## Column Narrative {data-height=250}
### SITUATION {.columntext}
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec quis urna mollis, hendrerit metus eget, tincidunt risus. Etiam maximus vitae orci sit amet tincidunt. Praesent neque libero, vulputate ullamcorper enim at, dictum tristique ex. Vestibulum vel quam condimentum, finibus quam vel, dapibus dui. Donec hendrerit lacus nec sem convallis elementum. Phasellus scelerisque ex ut ornare semper. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nullam erat justo, condimentum id lorem id, aliquet ornare elit. Suspendisse eget eros ac leo rhoncus mattis ut et ex.
<br><br>
Nulla ultrices vulputate mi, quis tincidunt risus pulvinar sed. Sed gravida accumsan ipsum, vitae consectetur nulla euismod a. Vivamus euismod diam ut odio aliquam, nec pellentesque augue laoreet. Sed bibendum iaculis luctus. In felis arcu, porta ac nibh eget, egestas pretium nulla. Aliquam rutrum, libero vel faucibus ultrices, magna lectus eleifend enim, egestas vehicula ex sem et mi. Duis faucibus enim at ultrices iaculis. Duis venenatis, ligula ac fringilla ultrices, lorem velit placerat est, a sollicitudin elit eros vitae libero.
<br><br>
Nunc eu ligula sagittis, mollis erat nec, finibus purus. Maecenas tristique varius luctus. Donec ac pretium sem, eu cursus eros. Aenean finibus quam eget pretium accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Aenean suscipit ligula id sem suscipit, gravida convallis elit euismod. Aliquam interdum risus eu ullamcorper tincidunt. Fusce elit quam, commodo id libero sit amet, ornare fermentum lacus. Nunc vel eros in ligula porta faucibus. Vivamus nec dolor vel metus lobortis eleifend id in ante.



### ADDITIONAL STRESSORS {.columntext}
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec quis urna mollis, hendrerit metus eget, tincidunt risus. Etiam maximus vitae orci sit amet tincidunt. Praesent neque libero, vulputate ullamcorper enim at, dictum tristique ex. Vestibulum vel quam condimentum, finibus quam vel, dapibus dui. Donec hendrerit lacus nec sem convallis elementum. Phasellus scelerisque ex ut ornare semper. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nullam erat justo, condimentum id lorem id, aliquet ornare elit. Suspendisse eget eros ac leo rhoncus mattis ut et ex.
<br><br>
Nulla ultrices vulputate mi, quis tincidunt risus pulvinar sed. Sed gravida accumsan ipsum, vitae consectetur nulla euismod a. Vivamus euismod diam ut odio aliquam, nec pellentesque augue laoreet. Sed bibendum iaculis luctus. In felis arcu, porta ac nibh eget, egestas pretium nulla. Aliquam rutrum, libero vel faucibus ultrices, magna lectus eleifend enim, egestas vehicula ex sem et mi. Duis faucibus enim at ultrices iaculis. Duis venenatis, ligula ac fringilla ultrices, lorem velit placerat est, a sollicitudin elit eros vitae libero.
<br><br>
Nunc eu ligula sagittis, mollis erat nec, finibus purus. Maecenas tristique varius luctus. Donec ac pretium sem, eu cursus eros. Aenean finibus quam eget pretium accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Aenean suscipit ligula id sem suscipit, gravida convallis elit euismod. Aliquam interdum risus eu ullamcorper tincidunt. Fusce elit quam, commodo id libero sit amet, ornare fermentum lacus. Nunc vel eros in ligula porta faucibus. Vivamus nec dolor vel metus lobortis eleifend id in ante.



### SECURITY{.columntext}
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec quis urna mollis, hendrerit metus eget, tincidunt risus. Etiam maximus vitae orci sit amet tincidunt. Praesent neque libero, vulputate ullamcorper enim at, dictum tristique ex. Vestibulum vel quam condimentum, finibus quam vel, dapibus dui. Donec hendrerit lacus nec sem convallis elementum. Phasellus scelerisque ex ut ornare semper. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nullam erat justo, condimentum id lorem id, aliquet ornare elit. Suspendisse eget eros ac leo rhoncus mattis ut et ex.
<br><br>
Nulla ultrices vulputate mi, quis tincidunt risus pulvinar sed. Sed gravida accumsan ipsum, vitae consectetur nulla euismod a. Vivamus euismod diam ut odio aliquam, nec pellentesque augue laoreet. Sed bibendum iaculis luctus. In felis arcu, porta ac nibh eget, egestas pretium nulla. Aliquam rutrum, libero vel faucibus ultrices, magna lectus eleifend enim, egestas vehicula ex sem et mi. Duis faucibus enim at ultrices iaculis. Duis venenatis, ligula ac fringilla ultrices, lorem velit placerat est, a sollicitudin elit eros vitae libero.
<br><br>
Nunc eu ligula sagittis, mollis erat nec, finibus purus. Maecenas tristique varius luctus. Donec ac pretium sem, eu cursus eros. Aenean finibus quam eget pretium accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Aenean suscipit ligula id sem suscipit, gravida convallis elit euismod. Aliquam interdum risus eu ullamcorper tincidunt. Fusce elit quam, commodo id libero sit amet, ornare fermentum lacus. Nunc vel eros in ligula porta faucibus. Vivamus nec dolor vel metus lobortis eleifend id in ante.



